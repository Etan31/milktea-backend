<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Your Cart</title>

<style>
  /* YOUR EXACT STYLES (unchanged) */
  body { font-family: Arial, sans-serif; background: #fff8f0; padding: 20px; }
  h1, h2 { color: #8e44ad; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 10px; text-align: center; vertical-align: middle; }
  th { background: #8e44ad; color: white; }
  .btn { padding: 8px 14px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
  .btn.cart { background: #3498db; color: white; }
  .btn.order { background: #f39c12; color: white; }
  .btn.checkout { background: #2ecc71; color: white; }
  .btn.remove { background: #e74c3c; color: white; }
  .btn.back { background: #95a5a6; color: white; }
  .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-top: 30px; }
  .product-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); text-align: center; }
  .product-card img { width: 100%; height: 160px; object-fit: contain; border-radius: 6px; background:#f9f9f9; }
  .actions { margin-top: 10px; }
  select, input { padding: 8px; border-radius: 5px; border: 1px solid #ccc; margin-top: 10px; }
  .thumb { width:60px; height:60px; object-fit:cover; border-radius:6px; }
  .cart-item-name { text-align:left; padding-left:10px; }
  .qty-controls { display:inline-flex; align-items:center; gap:8px; }
  .qty-controls button { padding:6px 10px; border-radius:6px; border:none; background:#8e44ad; color:white; cursor:pointer; }
  .qty-number { min-width:36px; display:inline-block; text-align:center; }
  @media (max-width:700px){
    .product-grid { grid-template-columns: repeat(auto-fill, minmax(140px,1fr)); }
    th, td { font-size:14px; padding:8px; }
    .product-card img { height:120px; }
  }
</style>

</head>
<body>

<h1>üõí Your Cart</h1>

<section id="checkoutSection">
  <div id="checkoutContainer"></div>
  <div id="totalAmount" style="font-weight:bold; margin-top:10px;"></div>

  <div style="margin-top:15px;">
    <label><b>üí≥ Select Payment Method:</b></label><br>
    <select id="paymentMethod">
      <option value="Cash on Delivery">Cash on Delivery</option>
      <option value="GCash">GCash</option>
      <option value="PayMaya">PayMaya</option>
    </select>
  </div>

  <div style="margin-top:15px;">
    <a href="homepage.html"><button class="btn back">‚Üê Continue Shopping</button></a>
    <button class="btn checkout" id="placeOrderBtn">‚úÖ Place Order</button>
  </div>
</section>

<h2>üçπ Available MilkTeas</h2>
<section class="product-grid" id="productContainer"></section>

<!-- DELIVERY POPUP (unchanged) -->
<div id="deliveryPopup" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:9999;">
  <div id="popupBox" style="background:white; padding:25px; width:380px; border-radius:10px; text-align:left; box-shadow:0 4px 10px rgba(0,0,0,0.2);">
    <h3 style="margin-top:0;color:#8e44ad;">üì¶ Confirm Your Delivery Info</h3>
    <div style="margin-bottom:10px;">
      <strong>Delivery To</strong>
      <div id="deliverySummary" style="margin-top:8px;">
        <p><b>Name:</b> <span id="dName">‚Äî</span></p>
        <p><b>Phone:</b> <span id="dPhone">‚Äî</span></p>
        <p><b>Address:</b> <span id="dAddress">‚Äî</span></p>
        <p><b>City:</b> <span id="dCity">‚Äî</span></p>
        <p><b>Postal Code:</b> <span id="dPostal">‚Äî</span></p>
      </div>
    </div>
    <div style="text-align:right;">
      <button class="btn back" onclick="closePopup()">Cancel</button>
      <button class="btn checkout" id="confirmOrderBtn">Confirm & Place Order</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getDatabase, ref, onValue, get, child, push, set } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

  // Firebase config ‚Äî same as your project
  const firebaseConfig = {
    apiKey: "AIzaSyCpXS9lRDsfHGzLwnT2YFFPM3bRU_6E3r0",
    authDomain: "e-library-bdbb1.firebaseapp.com",
    databaseURL: "https://e-library-bdbb1-default-rtdb.firebaseio.com",
    projectId: "e-library-bdbb1",
    storageBucket: "e-library-bdbb1.appspot.com",
    messagingSenderId: "721888979016",
    appId: "1:721888979016:web:fe65826bc262189a11107d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  let currentUser = null;
  let allProducts = [];
  let deliveryInfoData = null;

  const productContainer = document.getElementById("productContainer");
  const checkoutContainer = document.getElementById("checkoutContainer");
  const totalAmount = document.getElementById("totalAmount");

  // PRODUCTS (robust read)
  onValue(ref(db, "products"), (snap) => {
    allProducts = [];
    snap.forEach(ch => {
      const data = ch.val() || {};
      allProducts.push({
        id: ch.key,
        name: data.name || "Unnamed MilkTea",
        price: Number(data.price) || 0,
        imageBase64: (data.imageBase64 && data.imageBase64.toString().trim()) ? data.imageBase64 : (data.imageUrl || "https://via.placeholder.com/200x160?text=No+Image")
      });
    });
    renderProducts(allProducts);
  });

  function renderProducts(list) {
    productContainer.innerHTML = "";
    list.forEach(p => {
      const card = document.createElement("div");
      card.className = "product-card";
      card.innerHTML = `
        <img src="${p.imageBase64}">
        <h3>${p.name}</h3>
        <p>‚Ç±${Number(p.price).toFixed(2)}</p>
        <div class="actions">
          <button class="btn order" onclick="buyNow('${p.id}')">Buy Now</button>
          <button class="btn cart" onclick="addToCart('${p.id}')">Add to Cart</button>
        </div>
      `;
      productContainer.appendChild(card);
    });
  }

  /* CART HELPERS */
  function getCart() {
    return JSON.parse(localStorage.getItem("cart") || "[]");
  }
  function saveCart(c) {
    // normalize each item before saving
    const normalized = c.map(i => ({
      id: i.id,
      name: i.name || "Unnamed",
      price: Number(i.price) || 0,
      qty: Number(i.qty) || 1,
      imageBase64: (i.imageBase64 && i.imageBase64.toString().trim()) ? i.imageBase64 : "https://via.placeholder.com/60"
    }));
    localStorage.setItem("cart", JSON.stringify(normalized));
    loadCheckout();
  }

  /* addToCart (safe) */
  window.addToCart = (pid) => {
    const p = allProducts.find(x => x.id === pid);
    if (!p) return alert("Product not found");

    const cart = getCart();
    const item = cart.find(x => x.id === pid);

    if (item) item.qty = Number(item.qty || 1) + 1;
    else cart.push({
      id: p.id,
      name: p.name,
      price: Number(p.price) || 0,
      qty: 1,
      imageBase64: p.imageBase64 || "https://via.placeholder.com/60"
    });

    saveCart(cart);
    alert(p.name + " added to cart!");
  };

  /* Buy Now */
  window.buyNow = (pid) => {
    const p = allProducts.find(x => x.id === pid);
    if (!p) return;
    saveCart([{
      id: p.id,
      name: p.name,
      price: Number(p.price) || 0,
      qty: 1,
      imageBase64: p.imageBase64 || "https://via.placeholder.com/60"
    }]);
    window.scrollTo({ top: 0, behavior:"smooth" });
  };

  /* Render cart (safe arithmetic) */
  function loadCheckout() {
    const cart = getCart();
    if (cart.length === 0) {
      checkoutContainer.innerHTML = "<p>Your cart is empty.</p>";
      totalAmount.innerHTML = "";
      return;
    }
    let html = `<table>
      <tr>
        <th>Item</th><th>Price</th><th>Quantity</th><th>Subtotal</th><th>Action</th>
      </tr>`;
    let total = 0;
    cart.forEach((item, i) => {
      const qty = Number(item.qty) || 1;
      const price = Number(item.price) || 0;
      const sub = price * qty;
      html += `<tr>
        <td style="display:flex;align-items:center;gap:10px;">
          <img src="${(item.imageBase64 && item.imageBase64.toString().trim()) ? item.imageBase64 : 'https://via.placeholder.com/60'}" class="thumb">
          <div class="cart-item-name">${item.name}</div>
        </td>
        <td>‚Ç±${price.toFixed(2)}</td>
        <td>
          <div class="qty-controls">
            <button onclick="changeQty(${i}, -1)">‚àí</button>
            <div class="qty-number">${qty}</div>
            <button onclick="changeQty(${i}, 1)">+</button>
          </div>
        </td>
        <td>‚Ç±${sub.toFixed(2)}</td>
        <td><button class="btn remove" onclick="removeItem(${i})">Remove</button></td>
      </tr>`;
      total += sub;
    });
    html += "</table>";
    checkoutContainer.innerHTML = html;
    totalAmount.innerHTML = `Total: ‚Ç±${total.toFixed(2)}`;
  }

  window.changeQty = (i, amt) => {
    const cart = getCart();
    if (!cart[i]) return;
    cart[i].qty = Math.max(1, Number(cart[i].qty || 1) + amt);
    saveCart(cart);
  };
  window.removeItem = (i) => {
    const cart = getCart();
    cart.splice(i, 1);
    saveCart(cart);
  };

  /* DELIVERY + PLACE ORDER */
  const placeOrderBtn = document.getElementById("placeOrderBtn");
  const confirmOrderBtn = document.getElementById("confirmOrderBtn");

  placeOrderBtn.onclick = async () => {
    if (!currentUser) {
      alert("Please login");
      return location.href = "login.html";
    }
    const snap = await get(child(ref(db), "deliveryInfo/" + currentUser.uid));
    if (!snap.exists()) {
      alert("Please fill delivery info in Profile");
      return location.href = "profile.html";
    }
    deliveryInfoData = snap.val();
    document.getElementById("dName").innerText = deliveryInfoData.fullName || "‚Äî";
    document.getElementById("dPhone").innerText = deliveryInfoData.contactNumber || "‚Äî";
    document.getElementById("dAddress").innerText = deliveryInfoData.address || "‚Äî";
    document.getElementById("dCity").innerText = deliveryInfoData.city || "‚Äî";
    document.getElementById("dPostal").innerText = deliveryInfoData.postalCode || "‚Äî";
    document.getElementById("deliveryPopup").style.display = "flex";
  };

  window.closePopup = () => document.getElementById("deliveryPopup").style.display = "none";

  confirmOrderBtn.onclick = async () => {
    const cart = getCart();
    if (cart.length === 0) return alert("Cart empty!");
    const payment = document.getElementById("paymentMethod").value;
    const orderRef = push(ref(db, "orders/" + currentUser.uid));
   // SAVE to Firebase (same as before)
await set(orderRef, {
  userEmail: currentUser.email,
  items: cart,
  total: cart.reduce((s,i) => s + (Number(i.price)||0) * (Number(i.qty)||1), 0),
  paymentMethod: payment,
  deliveryInfo: deliveryInfoData,
  orderedAt: new Date().toISOString(),
  status: "Pending"
});

// ALSO SAVE to PostgreSQL (NEW)
await fetch("http://localhost:5000/api/orders/create", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    user_id: currentUser.uid,
    email: currentUser.email,
    items: cart,
    total_amount: cart.reduce((s,i) => s + (Number(i.price)||0) * (Number(i.qty)||1), 0),
    payment_method: payment,
    delivery_info: deliveryInfoData
  })
});

    alert("Order placed!");
    localStorage.removeItem("cart");
    location.href = "profile.html";
  };

  onAuthStateChanged(auth, (u) => currentUser = u || null);
  loadCheckout();

</script>

</body>
</html>
